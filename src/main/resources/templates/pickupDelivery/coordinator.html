<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Delivery Coordinator Dashboard</title>
    <link rel="stylesheet" th:href="@{/css/common.css}">
</head>
<body>
<header class="header">
    <div class="container">
        <div class="header-content">
            <div class="logo">
                <span>ðŸ§º</span>
                <h1>FreshFold Laundry</h1>
            </div>
            <nav>
                <ul class="nav-menu">
                    <li><a th:href="@{/}">Home</a></li>
                    <li><a th:href="@{/schedule}">Schedule Pickup</a></li>
                    <li><a th:href="@{/track}">Track Order</a></li>
                    <li><a th:href="@{/coordinator}" class="active">Coordinator</a></li>
                    <li><a th:href="@{/driver(driverId=1)}">Driver</a></li>
                </ul>
            </nav>
        </div>
    </div>
</header>

<main class="container">
    <!-- Success/Error Messages -->
    <div th:if="${successMessage}" class="alert alert-success">
        <strong>Success!</strong> <span th:text="${successMessage}"></span>
    </div>

    <div th:if="${errorMessage}" class="alert alert-danger">
        <strong>Error!</strong> <span th:text="${errorMessage}"></span>
    </div>

    <div class="card">
        <h2>Delivery Coordinator Dashboard</h2>
        <p>Assign delivery drivers to completed orders ready for delivery</p>
        <p><strong>Current View:</strong> <span th:text="${status != null ? #strings.capitalize(status) : 'All'}" class="status-badge"></span> Orders</p>
    </div>

    <!-- Status Filter -->
    <div class="card">
        <h3>Filter Orders by Status</h3>
        <div class="filter-buttons">
            <a th:href="@{/coordinator}" class="btn btn-primary" th:classappend="${status == 'COMPLETED' or status == null ? ' active' : ''}">Completed Orders</a>
            <a th:href="@{/coordinator(status='ready_for_delivery')}" class="btn btn-secondary" th:classappend="${status == 'ready_for_delivery' ? ' active' : ''}">Ready for Delivery</a>
            <a th:href="@{/coordinator(status='out_for_delivery')}" class="btn btn-secondary" th:classappend="${status == 'out_for_delivery' ? ' active' : ''}">Out for Delivery</a>
            <a th:href="@{/coordinator(status='delivered')}" class="btn btn-secondary" th:classappend="${status == 'delivered' ? ' active' : ''}">Delivered</a>
        </div>
    </div>

    <!-- Available Drivers Info -->
    <div class="card" th:if="${drivers != null and !#lists.isEmpty(drivers)}">
        <h3>Available Delivery Staff</h3>
        <div class="drivers-list">
            <span th:each="driver, iterStat : ${drivers}" class="driver-badge">
                <span th:text="${driver.name}"></span>
                <small th:text="'(' + ${driver.contact} + ')'"></small>
                <span th:if="${!iterStat.last}">, </span>
            </span>
        </div>
        <p><small><strong th:text="${#lists.size(drivers)}"></strong> drivers available for assignment</small></p>
    </div>

    <div th:if="${drivers == null or #lists.isEmpty(drivers)}" class="alert alert-warning">
        <strong>No available delivery drivers!</strong> All drivers are currently assigned to active deliveries.
    </div>

    <!-- Orders Table -->
    <div th:if="${#lists.isEmpty(orders)}" class="alert alert-info">
        <strong>No orders found</strong> with status "<span th:text="${status}"></span>"
    </div>

    <div th:unless="${#lists.isEmpty(orders)}">
        <div class="card">
            <h3>Orders (<span th:text="${#lists.size(orders)}"></span>)</h3>
            <table class="table">
                <thead>
                <tr>
                    <th>Order ID</th>
                    <th>Customer</th>
                    <th>Address</th>
                    <th>Service Type</th>
                    <th>Status</th>
                    <th>Delivery Driver</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="order : ${orders}">
                    <td th:text="${order.orderId}"></td>
                    <td>
                        <strong th:text="${order.customerName}"></strong><br>
                        <small th:text="${order.customerPhone}"></small>
                    </td>
                    <td th:text="${order.customerAddress}"></td>
                    <td th:text="${order.serviceType}"></td>
                    <td>
                        <span class="status-badge" th:classappend="'status-' + ${order.status}" th:text="${#strings.replace(order.status, '_', ' ')}"></span>
                    </td>
                    <td th:text="${order.deliveryDriverId != null ? 'Driver ID: ' + order.deliveryDriverId : 'Not Assigned'}"></td>
                    <td>
                        <!-- Debug Information - Remove this after fixing -->
                        <div style="background: #f8f9fa; padding: 5px; margin: 5px 0; font-size: 10px; border: 1px solid #dee2e6;">
                            <strong>DEBUG:</strong><br>
                            Status: '<span th:text="${order.status}"></span>'<br>
                            DeliveryDriverId: '<span th:text="${order.deliveryDriverId}"></span>'<br>
                            Drivers available: <span th:text="${drivers != null and !#lists.isEmpty(drivers)}"></span><br>
                            Status == 'Completed': <span th:text="${order.status == 'Completed'}"></span><br>
                            Status == 'COMPLETED': <span th:text="${order.status == 'COMPLETED'}"></span><br>
                            Status == 'completed': <span th:text="${order.status == 'completed'}"></span><br>
                            DriverId == null: <span th:text="${order.deliveryDriverId == null}"></span><br>
                            DriverId == 0: <span th:text="${order.deliveryDriverId == 0}"></span><br>
                            No Driver Assigned: <span th:text="${order.deliveryDriverId == null or order.deliveryDriverId == 0}"></span>
                        </div>

                        <!-- Assign Delivery Driver for Completed Orders - Fixed to handle deliveryDriverId=0 -->
                        <form th:if="${(status == 'COMPLETED' or status == null) and (order.status == 'Completed' or order.status == 'COMPLETED' or order.status == 'completed') and (order.deliveryDriverId == null or order.deliveryDriverId == 0) and drivers != null and !#lists.isEmpty(drivers)}"
                              th:action="@{/assignDeliveryDriver/{orderId}(orderId=${order.orderId})}" method="post" style="display: inline;">
                            <select name="driverId" required>
                                <option value="">Select Driver</option>
                                <option th:each="driver : ${drivers}" th:value="${driver.id}" th:text="${driver.name + ' (' + driver.contact + ')'}"></option>
                            </select>
                            <button type="submit" class="btn btn-primary btn-sm">Assign Delivery Driver</button>
                        </form>

                        <!-- Show message when conditions are not met - Only in Completed section -->
                        <div th:if="${(status == 'COMPLETED' or status == null) and (order.status != 'Completed' and order.status != 'COMPLETED' and order.status != 'completed')}" class="text-muted">
                            <small>Status is not 'Completed': <span th:text="${order.status}"></span></small>
                        </div>

                        <div th:if="${(status == 'COMPLETED' or status == null) and (order.status == 'Completed' or order.status == 'COMPLETED' or order.status == 'completed') and order.deliveryDriverId != null and order.deliveryDriverId != 0}" class="text-info">
                            <small>Driver already assigned: <span th:text="${order.deliveryDriverId}"></span></small>
                        </div>

                        <div th:if="${(status == 'COMPLETED' or status == null) and (order.status == 'Completed' or order.status == 'COMPLETED' or order.status == 'completed') and (order.deliveryDriverId == null or order.deliveryDriverId == 0) and (drivers == null or #lists.isEmpty(drivers))}" class="text-warning">
                            <small>No drivers available for assignment</small>
                        </div>

                        <!-- Mark as Out for Delivery (only for ready_for_delivery status and in ready_for_delivery section) -->
                        <form th:if="${status == 'ready_for_delivery' and order.status == 'ready_for_delivery'}"
                              th:action="@{/updateStatus/{id}(id=${order.orderId})}" method="post" style="display: inline;">
                            <input type="hidden" name="status" value="out_for_delivery"/>
                            <button type="submit" class="btn btn-warning btn-sm">Send Out for Delivery</button>
                        </form>

                        <!-- Status indicators for different stages -->
                        <div th:if="${order.status == 'out_for_delivery'}" class="text-info">
                            <small>ðŸ“¦ Out for delivery - Driver will mark as delivered</small>
                        </div>

                        <div th:if="${order.status == 'delivered'}" class="text-success">
                            <small>âœ… Delivered by driver</small>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</main>

<footer class="footer">
    <div class="container">
        <p>&copy; 2023 FreshFold Laundry. All rights reserved.</p>
    </div>
</footer>

<style>
.filter-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}
.filter-buttons .btn.active {
    background-color: #007bff;
    color: white;
}
.drivers-list {
    margin: 10px 0;
}
.driver-badge {
    background-color: #e9f7ef;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 0.9em;
}
.status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8em;
    font-weight: bold;
}
.status-completed { background-color: #d4edda; color: #155724; }
.status-ready_for_delivery { background-color: #fff3cd; color: #856404; }
.status-out_for_delivery { background-color: #cce7ff; color: #004085; }
.status-delivered { background-color: #d1ecf1; color: #0c5460; }
.alert {
    padding: 15px;
    margin: 20px 0;
    border: 1px solid transparent;
    border-radius: 4px;
}
.alert-info { background-color: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
.alert-warning { background-color: #fff3cd; border-color: #ffeaa7; color: #856404; }
.text-muted { color: #6c757d; }
.text-success { color: #28a745; }
</style>
</body>
</html>