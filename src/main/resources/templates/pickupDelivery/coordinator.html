<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Delivery Coordinator Dashboard</title>
    <link rel="stylesheet" th:href="@{/css/common.css}">
</head>
<body>
<header class="header">
    <div class="container">
        <div class="header-content">
            <div class="logo">
                <span>üß∫</span>
                <h1>FreshFold Laundry</h1>
            </div>
            <nav>
                <ul class="nav-menu">
                    <li><a th:href="@{/}">Home</a></li>
                    <li><a th:href="@{/schedule}">Schedule Pickup</a></li>
                    <li><a th:href="@{/track}">Track Order</a></li>
                    <li><a th:href="@{/coordinator}" class="active">Coordinator</a></li>
                    <li><a th:href="@{/driver(driverId=1)}">Driver</a></li>
                </ul>
            </nav>
        </div>
    </div>
</header>

<main class="container">
    <!-- Success/Error Messages -->
    <div th:if="${successMessage}" class="alert alert-success">
        <strong>Success!</strong> <span th:text="${successMessage}"></span>
    </div>

    <div th:if="${errorMessage}" class="alert alert-danger">
        <strong>Error!</strong> <span th:text="${errorMessage}"></span>
    </div>

    <div class="card">
        <h2>Delivery Coordinator Dashboard</h2>
        <p>Assign pickup and delivery drivers to orders</p>
        <p><strong>Current View:</strong> <span th:text="${status != null ? #strings.capitalize(status) : 'Pending'}" class="status-badge"></span> Orders</p>
    </div>

    <!-- Status Filter - Updated for new workflow -->
    <div class="card">
        <h3>Filter Orders by Status</h3>
        <div class="filter-buttons">
            <a th:href="@{/coordinator}" class="btn btn-primary" th:classappend="${status == 'Pending' or status == null ? ' active' : ''}">üìã Pending Orders (Pickup Assignment)</a>
            <a th:href="@{/coordinator(status='Ready for Pickup')}" class="btn btn-secondary" th:classappend="${status == 'Ready for Pickup' ? ' active' : ''}">‚è≥ Ready for Pickup</a>
            <a th:href="@{/coordinator(status='Picked Up')}" class="btn btn-secondary" th:classappend="${status == 'Picked Up' ? ' active' : ''}">‚úÖ Picked Up</a>
            <a th:href="@{/coordinator(status='COMPLETED')}" class="btn btn-secondary" th:classappend="${status == 'COMPLETED' ? ' active' : ''}">üöö Completed (Delivery Assignment)</a>
            <a th:href="@{/coordinator(status='ready_for_delivery')}" class="btn btn-secondary" th:classappend="${status == 'ready_for_delivery' ? ' active' : ''}">üì¶ Ready for Delivery</a>
            <a th:href="@{/coordinator(status='out_for_delivery')}" class="btn btn-secondary" th:classappend="${status == 'out_for_delivery' ? ' active' : ''}">üöõ Out for Delivery</a>
            <a th:href="@{/coordinator(status='delivered')}" class="btn btn-secondary" th:classappend="${status == 'delivered' ? ' active' : ''}">‚úÖ Delivered</a>
        </div>
    </div>

    <!-- Available Drivers Info -->
    <div class="card" th:if="${drivers != null and !#lists.isEmpty(drivers)}">
        <h3>
            <span th:if="${status == 'Pending' or status == null}">Available Pickup Drivers</span>
            <span th:if="${status == 'COMPLETED'}">Available Delivery Drivers</span>
            <span th:if="${status != 'Pending' and status != 'COMPLETED' and status != null}">Available Drivers</span>
        </h3>
        <div class="drivers-list">
            <span th:each="driver, iterStat : ${drivers}" class="driver-badge">
                <span th:text="${driver.name}"></span>
                <small th:text="'(' + ${driver.contact} + ')'"></small>
                <span th:if="${!iterStat.last}">, </span>
            </span>
        </div>
        <p><small><strong th:text="${#lists.size(drivers)}"></strong> drivers available for assignment</small></p>
    </div>

    <div th:if="${drivers == null or #lists.isEmpty(drivers)}" class="alert alert-warning">
        <strong>No available delivery drivers!</strong> All drivers are currently assigned to active deliveries.
    </div>

    <!-- Orders Table -->
    <div th:if="${#lists.isEmpty(orders)}" class="alert alert-info">
        <strong>No orders found</strong> with status "<span th:text="${status}"></span>"
    </div>

    <div th:unless="${#lists.isEmpty(orders)}">
        <div class="card">
            <h3>Orders (<span th:text="${#lists.size(orders)}"></span>)</h3>
            <table class="table">
                <thead>
                <tr>
                    <th>Order ID</th>
                    <th>Customer</th>
                    <th>Address</th>
                    <th>Service Type</th>
                    <th>Status</th>
                    <th>Delivery Driver</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="order : ${orders}">
                    <td th:text="${order.orderId}"></td>
                    <td>
                        <strong th:text="${order.customerName}"></strong><br>
                        <small th:text="${order.customerPhone}"></small>
                    </td>
                    <td th:text="${order.customerAddress}"></td>
                    <td th:text="${order.serviceType}"></td>
                    <td>
                        <span class="status-badge" th:classappend="'status-' + ${order.status}" th:text="${#strings.replace(order.status, '_', ' ')}"></span>
                    </td>
                    <td th:text="${order.deliveryDriverId != null ? 'Driver ID: ' + order.deliveryDriverId : 'Not Assigned'}"></td>
                    <td>
                        <!-- PICKUP DRIVER ASSIGNMENT - For Pending Orders -->
                        <div th:if="${status == 'Pending' or status == null}">
                            <!-- Assign Pickup Driver for Pending Orders -->
                            <form th:if="${order.status == 'Pending' and (order.pickupDriverId == null or order.pickupDriverId == 0) and drivers != null and !#lists.isEmpty(drivers)}"
                                  th:action="@{/assignPickupDriver/{orderId}(orderId=${order.orderId})}" method="post" style="display: inline;">
                                <select name="driverId" required>
                                    <option value="">Select Pickup Driver</option>
                                    <option th:each="driver : ${drivers}" th:value="${driver.id}" th:text="${driver.name + ' (' + driver.contact + ')'}"></option>
                                </select>
                                <button type="submit" class="btn btn-success btn-sm">üìã Assign Pickup Driver</button>
                            </form>

                            <!-- Show when pickup driver already assigned -->
                            <div th:if="${order.status == 'Pending' and order.pickupDriverId != null and order.pickupDriverId != 0}" class="text-success">
                                <small>‚úÖ Pickup Driver assigned: ID <span th:text="${order.pickupDriverId}"></span></small>
                            </div>

                            <!-- Show when no drivers available -->
                            <div th:if="${order.status == 'Pending' and (order.pickupDriverId == null or order.pickupDriverId == 0) and (drivers == null or #lists.isEmpty(drivers))}" class="text-warning">
                                <small>‚ö†Ô∏è No pickup drivers available</small>
                            </div>
                        </div>

                        <!-- DELIVERY DRIVER ASSIGNMENT - For Completed Orders -->
                        <div th:if="${status == 'COMPLETED'}">
                            <!-- Assign Delivery Driver for Completed Orders -->
                            <form th:if="${(order.status == 'Completed' or order.status == 'COMPLETED' or order.status == 'completed') and (order.deliveryDriverId == null or order.deliveryDriverId == 0) and drivers != null and !#lists.isEmpty(drivers)}"
                                  th:action="@{/assignDeliveryDriver/{orderId}(orderId=${order.orderId})}" method="post" style="display: inline;">
                                <select name="driverId" required>
                                    <option value="">Select Delivery Driver</option>
                                    <option th:each="driver : ${drivers}" th:value="${driver.id}" th:text="${driver.name + ' (' + driver.contact + ')'}"></option>
                                </select>
                                <button type="submit" class="btn btn-primary btn-sm">üöö Assign Delivery Driver</button>
                            </form>

                            <!-- Show when delivery driver already assigned -->
                            <div th:if="${(order.status == 'Completed' or order.status == 'COMPLETED' or order.status == 'completed') and order.deliveryDriverId != null and order.deliveryDriverId != 0}" class="text-info">
                                <small>‚úÖ Delivery Driver assigned: ID <span th:text="${order.deliveryDriverId}"></span></small>
                            </div>

                            <!-- Show when no drivers available -->
                            <div th:if="${(order.status == 'Completed' or order.status == 'COMPLETED' or order.status == 'completed') and (order.deliveryDriverId == null or order.deliveryDriverId == 0) and (drivers == null or #lists.isEmpty(drivers))}" class="text-warning">
                                <small>‚ö†Ô∏è No delivery drivers available</small>
                            </div>
                        </div>

                        <!-- STATUS MANAGEMENT - For other statuses -->
                        <div th:if="${status != 'Pending' and status != 'COMPLETED'}">
                            <!-- Mark as Out for Delivery (only for ready_for_delivery status) -->
                            <form th:if="${status == 'ready_for_delivery' and order.status == 'ready_for_delivery'}"
                                  th:action="@{/updateStatus/{id}(id=${order.orderId})}" method="post" style="display: inline;">
                                <input type="hidden" name="status" value="out_for_delivery"/>
                                <button type="submit" class="btn btn-warning btn-sm">üöõ Send Out for Delivery</button>
                            </form>

                            <!-- Status indicators for different stages -->
                            <div th:if="${order.status == 'Ready for Pickup'}" class="text-info">
                                <small>‚è≥ Ready for pickup - Driver will collect</small>
                            </div>

                            <div th:if="${order.status == 'Picked Up'}" class="text-success">
                                <small>‚úÖ Picked up - Ready for manager assignment</small>
                            </div>

                            <div th:if="${order.status == 'out_for_delivery'}" class="text-info">
                                <small>üì¶ Out for delivery - Driver will mark as delivered</small>
                            </div>

                            <div th:if="${order.status == 'delivered'}" class="text-success">
                                <small>‚úÖ Delivered by driver</small>
                            </div>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</main>

<footer class="footer">
    <div class="container">
        <p>&copy; 2023 FreshFold Laundry. All rights reserved.</p>
    </div>
</footer>

<style>
.filter-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}
.filter-buttons .btn.active {
    background-color: #007bff;
    color: white;
}
.drivers-list {
    margin: 10px 0;
}
.driver-badge {
    background-color: #e9f7ef;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 0.9em;
}
.status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8em;
    font-weight: bold;
}
.status-completed { background-color: #d4edda; color: #155724; }
.status-ready_for_delivery { background-color: #fff3cd; color: #856404; }
.status-out_for_delivery { background-color: #cce7ff; color: #004085; }
.status-delivered { background-color: #d1ecf1; color: #0c5460; }
.alert {
    padding: 15px;
    margin: 20px 0;
    border: 1px solid transparent;
    border-radius: 4px;
}
.alert-info { background-color: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
.alert-warning { background-color: #fff3cd; border-color: #ffeaa7; color: #856404; }
.text-muted { color: #6c757d; }
.text-success { color: #28a745; }
</style>
</body>
</html>