<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>Manager Dashboard - LaundryApp</title>
    <link rel="stylesheet" href="/css/manager-dashboard.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-brand">
            <h2>LaundryApp Manager</h2>
        </div>
        <div class="navbar-menu">
            <a href="/dashboard" class="nav-link">Home</a>
            <a href="/manager/reports" class="nav-link">Reports</a>
            <div class="user-profile">
                <i class="fas fa-user-circle"></i>
                <span>Manager</span>
                <a href="/logout" class="logout-btn">Logout</a>
            </div>
        </div>
    </nav>

    <!-- Main Dashboard Content -->
    <div class="dashboard-container">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <h1>Manager Dashboard</h1>
            <div class="stats-cards">
                <!--
                <div class="stat-card">
                    <div class="stat-icon pending">
                        <i class="fas fa-clock"></i>
                    </div>

                    <div class="stat-info">
                        <h3 th:text="${#lists.size(pendingPayments)}">0</h3>
                        <p>Pending Payments</p>
                    </div>
                </div> -->
                <div class="stat-card">
                    <div class="stat-icon orders">
                        <i class="fas fa-tasks"></i>
                    </div>
                    <div class="stat-info">
                        <h3 th:text="${#lists.size(ordersForAssignment)}">0</h3>
                        <p>Orders to Assign</p>
                    </div>
                </div>
                <div class="stat-card">
                    <!--
                    <div class="stat-icon delivery">
                        <i class="fas fa-truck"></i>
                    </div>
                    <div class="stat-info">
                        <h3 th:text="${#lists.size(ordersForDelivery)}">0</h3>
                        <p>Ready for Delivery</p>
                    </div>
                </div>
                -->
                <div class="stat-card">
                    <div class="stat-icon staff">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-info">
                        <h3 th:text="${#lists.size(staffList)}">0</h3>
                        <p>Available Staff</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pending Payments Section
        <div class="section-card">
            <div class="section-header">
                <h2><i class="fas fa-credit-card"></i> Payment Verification</h2>
                <span class="section-count" th:text="${#lists.size(pendingPayments)} + ' pending'">0 pending</span>
            </div>
            <div class="table-container">
                <table class="data-table" th:if="${!#lists.isEmpty(pendingPayments)}">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Service</th>
                            <th>Amount</th>
                            <th>Card Details</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="payment : ${pendingPayments}" th:attr="data-order-id=${payment.orderId}">
                            <td th:text="'#' + ${payment.orderId}">#001</td>
                            <td th:text="${payment.customerId}">Customer ID</td>
                            <td>
                                <div class="service-info">
                                    <span th:text="${payment.serviceType}">Wash & Fold</span>
                                    <small th:text="${payment.clothType}">Shirt</small>
                                </div>
                            </td>
                            <td class="amount" th:text="${payment.price != null} ? 'Rs ' + ${payment.price} : 'Rs 0.00'">Rs 450.00</td>
                            <td>
                                <div class="card-details" th:with="len=${payment.cardNumber != null} ? ${#strings.length(payment.cardNumber)} : 0">
                                    <div th:text="${payment.cardNumber != null and len >= 4} ? '**** **** **** ' + ${#strings.substring(payment.cardNumber, len - 4)} : 'N/A'">**** **** **** 1234</div>
                                    <small th:text="${payment.cardHolderName} != null ? ${payment.cardHolderName} : 'Unknown'">John Doe</small>
                                    <small th:text="${payment.expiryDate} != null ? 'Exp: ' + ${payment.expiryDate} : 'Exp: --/--'">Exp: 12/25</small>
                                </div>
                            </td>
                            <td th:text="${payment.orderDate} != null ? ${#temporals.format(payment.orderDate, 'dd/MM/yyyy HH:mm')} : '-'">24/09/2025 14:30</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-approve" th:onclick="'verifyPayment(' + ${payment.orderId} + ', \'approve\')'">
                                        <i class="fas fa-check"></i> Approve
                                    </button>
                                    <button class="btn-reject" th:onclick="'verifyPayment(' + ${payment.orderId} + ', \'reject\')'">
                                        <i class="fas fa-times"></i> Reject
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div class="empty-state" th:if="${#lists.isEmpty(pendingPayments)}">
                    <i class="fas fa-check-circle"></i>
                    <p>No pending payments to verify</p>
                </div>
            </div>
        </div>
        -->

        <!-- Staff Assignment Section -->
        <div class="section-card">
            <div class="section-header">
                <h2><i class="fas fa-user-plus"></i> Staff Assignment</h2>
                <span class="section-count" th:text="${#lists.size(ordersForAssignment)} + ' picked up orders'">0 picked up orders</span>
            </div>
            <div class="table-container">
                <table class="data-table" th:if="${!#lists.isEmpty(ordersForAssignment)}">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Service</th>
                            <th>Items</th>
                            <th>Pickup Status</th>
                            <th>Assign to Staff</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="order : ${ordersForAssignment}" th:attr="data-order-id=${order.orderId}">
                            <td th:text="'#' + ${order.orderId}">#002</td>
                            <td th:text="${order.customerId}">Customer ID</td>
                            <td>
                                <div class="service-info">
                                    <span th:text="${order.serviceType}">Dry Cleaning</span>
                                    <small th:text="${order.clothType}">Suit</small>
                                </div>
                            </td>
                            <td th:text="${order.quantity} != null ? ${order.quantity} + ' items' : '0 items'">2 items</td>
                            <td><span class="status-badge picked-up">âœ… Picked Up</span></td>
                            <td>
                                <select class="staff-select enhanced-dropdown" th:id="'staff-' + ${order.orderId}">
                                    <option value="">Select Staff</option>
                                    <option th:each="staff : ${staffList}"
                                            th:value="${staff.id}"
                                            th:text="${staff.firstName != null ? staff.firstName : 'Staff'} + ' ' + ${staff.lastName != null ? staff.lastName : ''}">
                                        Staff Name
                                    </option>
                                </select>
                            </td>
                            <td>
                                <button class="btn-assign enhanced-assign-btn" th:onclick="'assignStaff(' + ${order.orderId} + ')'">
                                    <i class="fas fa-user-plus"></i> Assign Staff
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div class="empty-state" th:if="${#lists.isEmpty(ordersForAssignment)}">
                    <i class="fas fa-clipboard-check"></i>
                    <p>No picked up orders waiting for staff assignment</p>
                    <small>Orders will appear here after pickup drivers mark them as "Picked Up"</small>
                </div>
            </div>
        </div>

        <!-- Delivery Assignment Section
        <div class="section-card">
            <div class="section-header">
                <h2><i class="fas fa-shipping-fast"></i> Delivery Assignment</h2>
                <span class="section-count" th:text="${#lists.size(ordersForDelivery)} + ' ready'">0 ready</span>
            </div>
            <div class="table-container">
                <table class="data-table" th:if="${!#lists.isEmpty(ordersForDelivery)}">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Service</th>
                            <th>Completed Date</th>
                            <th>Assign Delivery</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="order : ${ordersForDelivery}" th:attr="data-order-id=${order.orderId}">
                            <td th:text="'#' + ${order.orderId}">#003</td>
                            <td th:text="${order.customerId}">Customer ID</td>
                            <td>
                                <div class="service-info">
                                    <span th:text="${order.serviceType}">Ironing</span>
                                    <small th:text="${order.clothType}">Trouser</small>
                                </div>
                            </td>
                            <td th:text="${order.orderDate} != null ? ${#temporals.format(order.orderDate, 'dd/MM/yyyy')} : '-'">23/09/2025</td>
                            <td>
                                <select class="staff-select enhanced-dropdown" th:id="'delivery-' + ${order.orderId}">
                                    <option value="">Select Delivery Staff</option>
                                    -->
                                    <!-- Delivery Assignment Dropdown (use deliveryStaffList)
                                    <option th:each="deliveryStaff : ${deliveryStaffList}"
                                            th:value="${deliveryStaff.id}"
                                            th:text="${deliveryStaff.firstName + ' ' + deliveryStaff.lastName}"></option>
                                </select>
                            </td>
                            <td>
                                <button class="btn-deliver enhanced-delivery-btn" th:onclick="'assignDelivery(' + ${order.orderId} + ')'">
                                    <i class="fas fa-truck"></i> Assign Delivery
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div class="empty-state" th:if="${#lists.isEmpty(ordersForDelivery)}">
                    <i class="fas fa-truck"></i>
                    <p>No orders ready for delivery</p>
                </div>
            </div>
        </div>
        -->

        <!-- Manager Chat Section -->
        <div class="chat-section" style="margin-top:40px;max-width:500px;">
            <h2>Chat with Delivery Staff</h2>
            <select id="deliveryStaffSelect" style="width:100%;margin-bottom:10px;">
                <option value="">Select Delivery Staff</option>
                <option th:each="deliveryStaff : ${deliveryStaffList}"
                        th:value="${deliveryStaff.id}"
                        th:text="${deliveryStaff.firstName + ' ' + deliveryStaff.lastName}"></option>
            </select>
            <div id="chat-window" style="border:1px solid #ccc;height:300px;overflow-y:auto;padding:10px;background:#222;color:#fff;"></div>
            <div style="display:flex;margin-top:10px;">
                <input type="text" id="chat-input" placeholder="Type your message..." style="flex:1;padding:8px;" />
                <button onclick="sendMessage()" style="padding:8px 16px;">Send</button>
            </div>
        </div>
        <form id="csrf-form" th:action="@{/chat/send}" method="post" style="display:none;">
            <input type="hidden" id="_csrf" name="_csrf" th:value="${_csrf.token}" th:name="${_csrf.parameterName}" />
        </form>
        <script src="/webjars/sockjs-client/1.5.1/sockjs.min.js"></script>
        <script src="/webjars/stomp-websocket/2.3.4/stomp.min.js"></script>
        <script src="/js/chat-websocket.js"></script>
        <script th:inline="javascript">
            const managerId = Number([[${managerId}]]);
            let selectedDeliveryStaffId = null;
            function appendMessage(msg) {
                const chatWindow = document.getElementById('chat-window');
                const align = Number(msg.senderId) === managerId ? 'right' : 'left';
                const color = align === 'right' ? '#1976d2' : '#1565c0';
                const bubble = `<div style='text-align:${align};margin:4px 0;'><span style='display:inline-block;background:${color};color:#fff;padding:6px 12px;border-radius:12px;'>${msg.message}</span></div>`;
                chatWindow.innerHTML += bubble;
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }
            function connectSelectedStaff() {
                if (selectedDeliveryStaffId) {
                    connectWebSocket(managerId, function(msg) {
                        // Only show messages for the selected staff
                        if ((Number(msg.senderId) === managerId && Number(msg.receiverId) === Number(selectedDeliveryStaffId)) ||
                            (Number(msg.senderId) === Number(selectedDeliveryStaffId) && Number(msg.receiverId) === managerId)) {
                            appendMessage(msg);
                        }
                    });
                }
            }
            document.getElementById('deliveryStaffSelect').addEventListener('change', function() {
                selectedDeliveryStaffId = this.value;
                document.getElementById('chat-window').innerHTML = '';
                connectSelectedStaff();
            });
            function sendMessage() {
                const input = document.getElementById('chat-input');
                const message = input.value.trim();
                if (!message || !selectedDeliveryStaffId) return;
                sendWebSocketMessage(managerId, Number(selectedDeliveryStaffId), message);
                input.value = '';
            }
        </script>
    </div>

    <!-- Success/Error Messages -->
    <div id="notification" class="notification">
        <div class="notification-content">
            <i class="notification-icon"></i>
            <span class="notification-message"></span>
        </div>
    </div>

    <script src="/js/manager-dashboard.js"></script>
    <style>
        /* Enhanced Button Styling for Manager Dashboard */
        .btn-approve, .btn-reject, .enhanced-assign-btn, .enhanced-delivery-btn {
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
            text-decoration: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        /* Enhanced Approve Button */
        .btn-approve {
            background: linear-gradient(135deg, #2ed573 0%, #1abc9c 100%);
            color: #fff;
            box-shadow: 0 4px 15px rgba(46, 213, 115, 0.4);
        }

        .btn-approve::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .btn-approve:hover::before {
            left: 100%;
        }

        .btn-approve:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(46, 213, 115, 0.6);
        }

        .btn-approve:active {
            transform: translateY(-1px) scale(1.02);
        }

        .btn-approve i {
            transition: transform 0.3s ease;
        }

        .btn-approve:hover i {
            transform: scale(1.2) rotate(10deg);
        }

        /* Enhanced Reject Button */
        .btn-reject {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: #fff;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
        }

        .btn-reject::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .btn-reject:hover::before {
            left: 100%;
        }

        .btn-reject:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.6);
        }

        .btn-reject:active {
            transform: translateY(-1px) scale(1.02);
        }

        .btn-reject i {
            transition: transform 0.3s ease;
        }

        .btn-reject:hover i {
            transform: scale(1.2) rotate(-10deg);
        }

        /* Enhanced Assign Staff Button */
        .enhanced-assign-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: #fff;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4);
        }

        .enhanced-assign-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .enhanced-assign-btn:hover::before {
            left: 100%;
        }

        .enhanced-assign-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.6);
        }

        .enhanced-assign-btn:active {
            transform: translateY(-1px) scale(1.02);
        }

        .enhanced-assign-btn i {
            transition: transform 0.3s ease;
        }

        .enhanced-assign-btn:hover i {
            transform: scale(1.2) rotate(15deg);
        }

        /* Enhanced Delivery Button */
        .enhanced-delivery-btn {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #2d3748;
            box-shadow: 0 4px 15px rgba(168, 237, 234, 0.4);
        }

        .enhanced-delivery-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s ease;
        }

        .enhanced-delivery-btn:hover::before {
            left: 100%;
        }

        .enhanced-delivery-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(168, 237, 234, 0.6);
            background: linear-gradient(135deg, #81e6d9 0%, #fbb6ce 100%);
        }

        .enhanced-delivery-btn:active {
            transform: translateY(-1px) scale(1.02);
        }

        .enhanced-delivery-btn i {
            transition: transform 0.3s ease;
        }

        .enhanced-delivery-btn:hover i {
            transform: scale(1.2) translateX(3px);
        }

        /* Enhanced Dropdown Styling */
        .enhanced-dropdown {
            appearance: none;
            background: linear-gradient(135deg, rgba(79, 172, 254, 0.15) 0%, rgba(0, 242, 254, 0.1) 100%);
            border: 2px solid rgba(79, 172, 254, 0.3);
            border-radius: 12px;
            padding: 0.75rem 2.5rem 0.75rem 1rem;
            color: #e8eaff;
            font-size: 0.9rem;
            font-weight: 600;
            min-width: 180px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .enhanced-dropdown:focus {
            outline: none;
            border-color: #4facfe;
            background: linear-gradient(135deg, rgba(79, 172, 254, 0.25) 0%, rgba(0, 242, 254, 0.2) 100%);
            box-shadow: 0 0 0 4px rgba(79, 172, 254, 0.2);
            transform: translateY(-2px);
        }

        .enhanced-dropdown:hover {
            border-color: #4facfe;
            background: linear-gradient(135deg, rgba(79, 172, 254, 0.2) 0%, rgba(0, 242, 254, 0.15) 100%);
            transform: translateY(-1px);
        }

        /* Custom dropdown arrow */
        .enhanced-dropdown {
            background-image:
                linear-gradient(135deg, rgba(79, 172, 254, 0.15) 0%, rgba(0, 242, 254, 0.1) 100%),
                url("data:image/svg+xml;charset=utf-8,%3csvg xmlns='http://www.w3.org/2000/svg' fill='%234facfe' viewBox='0 0 16 16'%3e%3cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 16px 12px;
        }

        /* Enhanced Priority Badge */
        .priority-badge {
            display: inline-block;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .priority-badge.normal {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .priority-badge.urgent {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: #fff;
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
        }

        .priority-badge.high {
            background: linear-gradient(135deg, #ffa726 0%, #fb8c00 100%);
            color: #fff;
            box-shadow: 0 2px 8px rgba(255, 167, 38, 0.3);
        }

        /* Button Loading State */
        .btn-approve.loading, .btn-reject.loading, .enhanced-assign-btn.loading, .enhanced-delivery-btn.loading {
            pointer-events: none;
            opacity: 0.7;
        }

        .btn-approve.loading::after, .btn-reject.loading::after, .enhanced-assign-btn.loading::after, .enhanced-delivery-btn.loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border: 2px solid transparent;
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: button-loading-spinner 1s ease infinite;
        }

        @keyframes button-loading-spinner {
            from {
                transform: rotate(0turn);
            }
            to {
                transform: rotate(1turn);
            }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .btn-approve, .btn-reject, .enhanced-assign-btn, .enhanced-delivery-btn {
                padding: 0.6rem 1rem;
                font-size: 0.8rem;
            }

            .enhanced-dropdown {
                min-width: 150px;
                padding: 0.6rem 2rem 0.6rem 0.8rem;
                font-size: 0.8rem;
            }
        }

        @media (max-width: 480px) {
            .btn-approve, .btn-reject, .enhanced-assign-btn, .enhanced-delivery-btn {
                padding: 0.5rem 0.8rem;
                font-size: 0.75rem;
                gap: 0.3rem;
            }

            .enhanced-dropdown {
                min-width: 120px;
                padding: 0.5rem 1.8rem 0.5rem 0.6rem;
                font-size: 0.75rem;
            }
        }

        /* Pulse animation for important actions */
        @keyframes pulse {
            0% {
                box-shadow: 0 4px 15px rgba(46, 213, 115, 0.4);
            }
            50% {
                box-shadow: 0 4px 15px rgba(46, 213, 115, 0.8);
            }
            100% {
                box-shadow: 0 4px 15px rgba(46, 213, 115, 0.4);
            }
        }

        .btn-approve {
            animation: pulse 2s infinite;
        }

        .btn-approve:hover {
            animation: none;
        }
    </style>
</body>
</html>
