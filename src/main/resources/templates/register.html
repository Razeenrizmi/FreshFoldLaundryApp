<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>Registration</title>
  <link rel="stylesheet" href="/css/register.css">
  <style>
    .error-message {
      color: #d32f2f;
      font-size: 12px;
      font-family: 'Poppins', sans-serif;
      margin-top: 5px;
      padding: 5px 10px;
      background: #ffebee;
      border-radius: 4px;
      border-left: 3px solid #d32f2f;
      display: none;
    }

    .success-message {
      color: #1976d2;
      font-size: 12px;
      font-family: 'Poppins', sans-serif;
      margin-top: 5px;
      padding: 5px 10px;
      background: #e3f2fd;
      border-radius: 4px;
      border-left: 3px solid #1976d2;
      display: none;
    }

    .input.error {
      border-color: #d32f2f !important;
      background-color: #ffebee !important;
    }

    .input.success {
      border-color: #1976d2 !important;
      background-color: #e3f2fd !important;
    }

    .password-strength {
      margin-top: 10px;
      margin-bottom: 20px;
      padding: 8px;
      background: #f3f9ff;
      border-radius: 6px;
      border: 1px solid #bbdefb;
      max-height: 150px;
      overflow: hidden;
    }

    .strength-meter {
      height: 3px;
      background: #e1f5fe;
      border-radius: 2px;
      margin: 4px 0;
      overflow: hidden;
    }

    .strength-fill {
      height: 100%;
      transition: all 0.3s ease;
      border-radius: 2px;
    }

    .strength-weak { background: #f44336; width: 25%; }
    .strength-fair { background: #ff9800; width: 50%; }
    .strength-good { background: #2196f3; width: 75%; }
    .strength-strong { background: #1976d2; width: 100%; }

    .requirements {
      list-style: none;
      padding: 0;
      margin: 6px 0 0 0;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2px 10px;
    }

    .requirements li {
      font-size: 10px;
      color: #64b5f6;
      margin: 1px 0;
      padding-left: 12px;
      position: relative;
    }

    .requirements li::before {
      content: '✗';
      color: #f44336;
      position: absolute;
      left: 0;
      transition: all 0.3s ease;
      font-size: 9px;
    }

    .requirements li.valid::before {
      content: '✓';
      color: #1976d2;
    }

    .requirements li.valid {
      color: #1976d2;
    }

    /* Ensure submit button has proper spacing and is always visible */
    .submit {
      margin-top: 25px !important;
      margin-bottom: 20px;
      position: relative;
      z-index: 10;
    }

    /* Add some responsive handling for smaller screens */
    @media (max-width: 480px) {
      .requirements {
        grid-template-columns: 1fr;
      }

      .password-strength {
        max-height: 180px;
      }
    }

    /* Strategy pattern validation styles */
    .strategy-indicator {
      font-size: 12px;
      margin-top: 5px;
      display: flex;
      align-items: center;
      padding: 4px 8px;
      border-radius: 4px;
      background: #f3f9ff;
      border: 1px solid #bbdefb;
    }

    .strategy-badge {
      margin-right: 8px;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 10px;
      background: #e3f2fd;
      color: #1976d2;
      font-weight: 500;
    }

    .strategy-valid {
      color: #1976d2;
      border-color: #1976d2;
      background: #e8f5e8;
    }

    .strategy-invalid {
      color: #d32f2f;
      border-color: #f44336;
      background: #ffebee;
    }

    .strategy-valid .strategy-badge {
      background: #1976d2;
      color: white;
    }

    .strategy-invalid .strategy-badge {
      background: #f44336;
      color: white;
    }

    .validation-summary {
      margin-top: 20px;
      padding: 15px;
      background: #ffffff;
      border: 1px solid #bbdefb;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(33, 150, 243, 0.1);
      position: relative;
    }

    .validation-summary h4 {
      margin: 0 0 10px 0;
      color: #1565c0;
      font-size: 16px;
    }

    .validation-type {
      font-size: 14px;
      margin: 8px 0;
      padding: 6px 10px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .validation-type.valid {
      color: #1976d2;
      background: #e3f2fd;
      border: 1px solid #bbdefb;
    }

    .validation-type.invalid {
      color: #d32f2f;
      background: #ffebee;
      border: 1px solid #ffcdd2;
    }

    .close-summary {
      background: none;
      border: none;
      color: #64b5f6;
      cursor: pointer;
      position: absolute;
      top: 10px;
      right: 12px;
      font-size: 18px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .close-summary:hover {
      background: #e3f2fd;
      color: #1976d2;
    }
  </style>
</head>
<body>
<div class="form">
  <form th:action="@{/register}" th:object="${user}" method="post" id="registrationForm" novalidate>
  <div class="title">Welcome</div>
  <div class="subtitle">Let's create your account!</div>

  <div class="input-container ic1">
    <input id="firstname" class="input" type="text" placeholder=" " th:field="*{firstName}" required />
    <div class="cut"></div>
    <label for="firstname" class="placeholder">First name</label>
    <div id="firstname-error" class="error-message"></div>
    <div id="firstname-success" class="success-message"></div>
  </div>

  <div class="input-container ic2">
    <input id="lastname" class="input" type="text" placeholder=" " th:field="*{lastName}" required />
    <div class="cut"></div>
    <label for="lastname" class="placeholder">Last name</label>
    <div id="lastname-error" class="error-message"></div>
    <div id="lastname-success" class="success-message"></div>
  </div>

  <div class="input-container ic2">
    <input id="Address" class="input" type="text" placeholder=" "th:field="*{address}" required />
    <div class="cut"></div>
    <label for="Address" class="placeholder">Address</label>
    <div id="address-error" class="error-message"></div>
    <div id="address-success" class="success-message"></div>
  </div>

  <div class="input-container ic2">
    <input id="phoneNumber" class="input" type="tel" placeholder=" "th:field="*{phoneNumber}" required />
    <div class="cut"></div>
    <label for="phoneNumber" class="placeholder">Phone Number</label>
    <div id="phone-error" class="error-message"></div>
    <div id="phone-success" class="success-message"></div>
  </div>

  <div class="input-container ic2">
    <input id="email" class="input" type="email" placeholder=" " th:field="*{email}" required />
    <div class="cut cut-short"></div>
    <label for="email" class="placeholder">Email</label>
    <div id="email-error" class="error-message"></div>
    <div id="email-success" class="success-message"></div>
  </div>

  <div class="input-container ic2">
    <input id="password" class="input" type="password" placeholder=" " th:field="*{password}" required />
    <div class="cut"></div>
    <label for="password" class="placeholder">Password</label>
    <div id="password-error" class="error-message"></div>
    <div class="password-strength" id="password-strength" style="display: none;">
      <div class="strength-meter">
        <div class="strength-fill" id="strength-fill"></div>
      </div>
      <div id="strength-text" style="font-size: 12px; font-weight: 600; color: #546e7a;"></div>
      <ul class="requirements">
        <li id="req-length">At least 8 characters</li>
        <li id="req-uppercase">One uppercase letter</li>
        <li id="req-lowercase">One lowercase letter</li>
        <li id="req-number">One number</li>
        <li id="req-special">One special character</li>
      </ul>
    </div>
  </div>

  <button type="submit" class="submit" id="submitBtn">Submit</button>
  </form>
    <div class="links">
        <a href="/login">Already have an account? Login</a>
      </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('registrationForm');
    const submitBtn = document.getElementById('submitBtn');

    // Validation patterns
    const patterns = {
        name: /^[a-zA-Z\s]{2,30}$/,
        phone: /^[0-9]{10,15}$/,
        email: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
        password: /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/
    };

    // Real-time validation functions
    function validateField(fieldId, pattern, errorMsg, successMsg) {
        const field = document.getElementById(fieldId);
        const errorDiv = document.getElementById(fieldId.replace(/([A-Z])/g, '-$1').toLowerCase() + '-error');
        const successDiv = document.getElementById(fieldId.replace(/([A-Z])/g, '-$1').toLowerCase() + '-success');

        field.addEventListener('input', function() {
            const value = this.value.trim();

            if (value === '') {
                showError(field, errorDiv, successDiv, '');
                return;
            }

            if (pattern.test(value)) {
                showSuccess(field, errorDiv, successDiv, successMsg);
            } else {
                showError(field, errorDiv, successDiv, errorMsg);
            }
        });

        field.addEventListener('blur', function() {
            const value = this.value.trim();
            if (value === '') {
                showError(field, errorDiv, successDiv, 'This field is required');
            }
        });
    }

    function showError(field, errorDiv, successDiv, message) {
        field.classList.remove('success');
        field.classList.add('error');
        errorDiv.textContent = message;
        errorDiv.style.display = message ? 'block' : 'none';
        successDiv.style.display = 'none';
    }

    function showSuccess(field, errorDiv, successDiv, message) {
        field.classList.remove('error');
        field.classList.add('success');
        successDiv.textContent = message;
        successDiv.style.display = 'block';
        errorDiv.style.display = 'none';
    }

    // Phone number specific validation (digits only)
    document.getElementById('phoneNumber').addEventListener('input', function(e) {
        // Remove any non-digit characters
        let value = e.target.value.replace(/[^\d]/g, '');
        e.target.value = value;

        const errorDiv = document.getElementById('phone-error');
        const successDiv = document.getElementById('phone-success');

        if (value === '') {
            showError(e.target, errorDiv, successDiv, '');
            return;
        }

        if (value.length < 10) {
            showError(e.target, errorDiv, successDiv, 'Phone number must be at least 10 digits');
        } else if (value.length > 10) {
            showError(e.target, errorDiv, successDiv, 'Phone number cannot exceed 10 digits');
        } else {
            showSuccess(e.target, errorDiv, successDiv, 'Valid phone number');
        }
    });

    // Password strength checker
    document.getElementById('password').addEventListener('input', function() {
        const password = this.value;
        const strengthDiv = document.getElementById('password-strength');
        const strengthFill = document.getElementById('strength-fill');
        const strengthText = document.getElementById('strength-text');

        if (password.length > 0) {
            strengthDiv.style.display = 'block';

            let strength = 0;
            const requirements = {
                length: password.length >= 8,
                uppercase: /[A-Z]/.test(password),
                lowercase: /[a-z]/.test(password),
                number: /\d/.test(password),
                special: /[@$!%*?&]/.test(password)
            };

            // Update requirement indicators
            document.getElementById('req-length').classList.toggle('valid', requirements.length);
            document.getElementById('req-uppercase').classList.toggle('valid', requirements.uppercase);
            document.getElementById('req-lowercase').classList.toggle('valid', requirements.lowercase);
            document.getElementById('req-number').classList.toggle('valid', requirements.number);
            document.getElementById('req-special').classList.toggle('valid', requirements.special);

            // Calculate strength
            strength = Object.values(requirements).filter(Boolean).length;

            // Update strength meter
            strengthFill.className = 'strength-fill';
            if (strength <= 2) {
                strengthFill.classList.add('strength-weak');
                strengthText.textContent = 'Weak';
                strengthText.style.color = '#d32f2f';
            } else if (strength === 3) {
                strengthFill.classList.add('strength-fair');
                strengthText.textContent = 'Fair';
                strengthText.style.color = '#ff9800';
            } else if (strength === 4) {
                strengthFill.classList.add('strength-good');
                strengthText.textContent = 'Good';
                strengthText.style.color = '#2196f3';
            } else if (strength === 5) {
                strengthFill.classList.add('strength-strong');
                strengthText.textContent = 'Strong';
                strengthText.style.color = '#2e7d32';

                // Hide password requirements when password is strong and valid
                setTimeout(() => {
                    strengthDiv.style.display = 'none';
                }, 1500); // Reduced from 2000ms to 1500ms for faster hiding
            }
        } else {
            strengthDiv.style.display = 'none';
        }
    });

    // Hide password requirements when user clicks outside or focuses on another field
    document.getElementById('password').addEventListener('blur', function() {
        const password = this.value;
        const strengthDiv = document.getElementById('password-strength');

        // If password meets all requirements, hide the indicator
        if (password.length >= 8 &&
            /[A-Z]/.test(password) &&
            /[a-z]/.test(password) &&
            /\d/.test(password) &&
            /[@$!%*?&]/.test(password)) {
            setTimeout(() => {
                strengthDiv.style.display = 'none';
            }, 500);
        }
    });

    // Show password requirements when user focuses on password field
    document.getElementById('password').addEventListener('focus', function() {
        const password = this.value;
        const strengthDiv = document.getElementById('password-strength');

        // Only show if password is not empty and doesn't meet all requirements
        if (password.length > 0) {
            const isComplete = password.length >= 8 &&
                              /[A-Z]/.test(password) &&
                              /[a-z]/.test(password) &&
                              /\d/.test(password) &&
                              /[@$!%*?&]/.test(password);

            if (!isComplete) {
                strengthDiv.style.display = 'block';
            }
        }
    });

    // Initialize field validations
    validateField('firstname', patterns.name, 'Name should contain only letters and be 2-30 characters long', 'Valid first name');
    validateField('lastname', patterns.name, 'Name should contain only letters and be 2-30 characters long', 'Valid last name');
    validateField('email', patterns.email, 'Please enter a valid email address', 'Valid email address');

    // Address validation (basic check for minimum length)
    document.getElementById('Address').addEventListener('input', function() {
        const value = this.value.trim();
        const errorDiv = document.getElementById('address-error');
        const successDiv = document.getElementById('address-success');

        if (value === '') {
            showError(this, errorDiv, successDiv, '');
        } else if (value.length < 10) {
            showError(this, errorDiv, successDiv, 'Address should be at least 10 characters long');
        } else {
            showSuccess(this, errorDiv, successDiv, 'Valid address');
        }
    });

    // Strategy Pattern Validation Integration
    let strategyValidationResults = {};

    // Function to validate using backend strategy pattern
    async function validateWithStrategy() {
        const formData = {
            firstName: document.getElementById('firstname').value,
            lastName: document.getElementById('lastname').value,
            email: document.getElementById('email').value,
            phoneNumber: document.getElementById('phoneNumber').value,
            password: document.getElementById('password').value,
            address: document.getElementById('Address').value
        };

        try {
            const response = await fetch('/validation-demo/validate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });

            const data = await response.json();
            strategyValidationResults = data;
            displayStrategyResults(data);
            return data.allValid;
        } catch (error) {
            console.error('Strategy validation error:', error);
            return false;
        }
    }

    // Function to display strategy validation results
    function displayStrategyResults(data) {
        // Remove any existing strategy indicators
        document.querySelectorAll('.strategy-indicator').forEach(el => el.remove());

        // Add strategy validation indicators to each field
        Object.entries(data.validations || {}).forEach(([fieldName, result]) => {
            const field = document.getElementById(fieldName) || document.getElementById(fieldName.toLowerCase());
            if (field) {
                const indicator = document.createElement('div');
                indicator.className = `strategy-indicator ${result.valid ? 'strategy-valid' : 'strategy-invalid'}`;
                indicator.innerHTML = `
                    <div class="strategy-badge">
                        ${result.valid ? '✅' : '❌'} Strategy Pattern
                    </div>
                    <div class="strategy-message">${result.message}</div>
                `;
                field.parentNode.appendChild(indicator);
            }
        });
    }

    // Enhanced form submission with strategy pattern validation
    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        // First run frontend validations
        const fields = ['firstname', 'lastname', 'Address', 'phoneNumber', 'email', 'password'];
        let frontendValid = true;

        fields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            const value = field.value.trim();

            if (value === '') {
                frontendValid = false;
                const errorDiv = document.getElementById(fieldId.replace(/([A-Z])/g, '-$1').toLowerCase() + '-error');
                const successDiv = document.getElementById(fieldId.replace(/([A-Z])/g, '-$1').toLowerCase() + '-success');
                showError(field, errorDiv, successDiv, 'This field is required');
            } else if (!field.classList.contains('success')) {
                frontendValid = false;
            }
        });

        // Then run strategy pattern validations
        const strategyValid = await validateWithStrategy();

        if (frontendValid && strategyValid) {
            // Show loading state
            submitBtn.textContent = 'Creating Account...';
            submitBtn.disabled = true;

            // Submit the form
            setTimeout(() => {
                this.submit();
            }, 500);
        } else {
            // Show validation summary
            showValidationSummary(frontendValid, strategyValid);

            // Scroll to first error
            const firstError = document.querySelector('.input.error');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstError.focus();
            }
        }
    });

    // Function to show validation summary
    function showValidationSummary(frontendValid, strategyValid) {
        // Remove existing summary
        const existingSummary = document.querySelector('.validation-summary');
        if (existingSummary) {
            existingSummary.remove();
        }

        const summary = document.createElement('div');
        summary.className = 'validation-summary';
        summary.innerHTML = `
            <h4>Validation Results</h4>
            <div class="validation-type ${frontendValid ? 'valid' : 'invalid'}">
                ${frontendValid ? '✅' : '❌'} Frontend Validation: ${frontendValid ? 'Passed' : 'Failed'}
            </div>
            <div class="validation-type ${strategyValid ? 'valid' : 'invalid'}">
                ${strategyValid ? '✅' : '❌'} Strategy Pattern Validation: ${strategyValid ? 'Passed' : 'Failed'}
            </div>
            <button onclick="this.parentElement.style.display='none'" class="close-summary">×</button>
        `;

        // Insert summary after the form title
        const subtitle = document.querySelector('.subtitle');
        subtitle.parentNode.insertBefore(summary, subtitle.nextSibling);
    }

    // Add real-time strategy validation
    document.addEventListener('DOMContentLoaded', function() {
        const inputs = document.querySelectorAll('.input');
        inputs.forEach(input => {
            input.addEventListener('blur', debounce(validateWithStrategy, 300));
        });
    });

    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
</script>

</body>
</html>